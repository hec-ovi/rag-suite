services:
  qdrant:
    image: qdrant/qdrant:v1.17.0
    container_name: rag-suite-qdrant
    restart: unless-stopped
    volumes:
      - ${QDRANT_STORAGE_DIR}:/qdrant/storage
    ports:
      - "6333:6333"
      - "6334:6334"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:6333/healthz"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 15s

  ollama:
    image: ollama/ollama:rocm
    container_name: rag-suite-ollama
    restart: unless-stopped
    privileged: true
    ipc: host
    environment:
      HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION}
      HIP_VISIBLE_DEVICES: ${HIP_VISIBLE_DEVICES}
      OLLAMA_MODELS: /ollama-models
      OLLAMA_HOST: 0.0.0.0:11434
      OLLAMA_FLASH_ATTENTION: ${OLLAMA_FLASH_ATTENTION}
      OLLAMA_KV_CACHE_TYPE: ${OLLAMA_KV_CACHE_TYPE}
      OLLAMA_KEEP_ALIVE: ${OLLAMA_KEEP_ALIVE}
      OLLAMA_NUM_PARALLEL: ${OLLAMA_NUM_PARALLEL}
      OLLAMA_MAX_LOADED_MODELS: ${OLLAMA_MAX_LOADED_MODELS}
      OLLAMA_CHAT_MODEL: ${OLLAMA_CHAT_MODEL}
      OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL}
    volumes:
      - ${OLLAMA_MODELS_DIR}:/ollama-models
      - ./ollama/entrypoint.sh:/entrypoint.sh:ro
    ports:
      - "11434:11434"
    command: ["/bin/bash", "/entrypoint.sh"]
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 60s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: rag-suite-backend
    restart: unless-stopped
    environment:
      DATABASE_URL: sqlite:///./data/control_plane.db
      QDRANT_URL: http://qdrant:6333
      OLLAMA_URL: http://ollama:11434
      OLLAMA_CHAT_MODEL: ${OLLAMA_CHAT_MODEL}
      OLLAMA_EMBEDDING_MODEL: ${OLLAMA_EMBEDDING_MODEL}
      QDRANT_COLLECTION_PREFIX: ${QDRANT_COLLECTION_PREFIX}
    volumes:
      - ${BACKEND_DATA_DIR}:/app/data
    depends_on:
      qdrant:
        condition: service_healthy
      ollama:
        condition: service_healthy
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8000/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 20s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rag-suite-frontend
    restart: unless-stopped
    environment:
      VITE_API_BASE_URL: http://backend:8000/v1
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "5173:5173"

networks:
  default:
    name: rag-suite-network
